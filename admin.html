<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨ | å¾Œå°ç®¡ç†</title>
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#5C4D42">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="logo.png">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dream: {
                            navy: '#5C4D42',
                            gold: '#C5A065',
                            cream: '#FAF8F5',
                            line: '#06C755',
                            red: '#E05D5D'
                        }
                    },
                    animation: {
                        'blob': 'blob 12s infinite',
                        'fade-up': 'fadeUp 0.8s ease-out forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-down': 'slideDown 0.3s ease-out forwards',
                        'shake': 'shake 0.4s ease-in-out',
                    },
                    keyframes: {
                        blob: {
                            '0%, 100%': { transform: 'translate(0, 0) scale(1)' },
                            '33%': { transform: 'translate(40px, -60px) scale(1.1)' },
                            '66%': { transform: 'translate(-30px, 30px) scale(0.9)' },
                        },
                        fadeUp: {
                            '0%': { opacity: '0', transform: 'translateY(30px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideDown: {
                            '0%': { opacity: '0', transform: 'translateY(-10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        shake: {
                            '0%, 100%': { transform: 'translateX(0)' },
                            '25%': { transform: 'translateX(-4px)' },
                            '75%': { transform: 'translateX(4px)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        
        body { 
            background: #FAF8F5;
            font-family: 'Noto Sans TC', sans-serif;
            color: #5C4D42;
            -webkit-font-smoothing: antialiased; 
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.3));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(92, 77, 66, 0.08);
        }

        .glass-button {
            position: relative;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }
        .glass-button:hover {
            transform: translateY(-3px);
            border-color: rgba(197, 160, 101, 0.5);
            box-shadow: 0 15px 30px -10px rgba(197, 160, 101, 0.25);
        }

        .glass-nav {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(92, 77, 66, 0.03);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(200, 200, 200, 0.5);
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            background: #fff;
            border-color: #C5A065;
            box-shadow: 0 0 0 3px rgba(197, 160, 101, 0.1);
            outline: none;
        }

        .shake { animation: shake 0.4s cubic-bezier(0.36, 0.07, 0.19, 0.97) both; }
        .touch-none { touch-action: none; }
        
        .fullscreen-modal {
            position: fixed;
            inset: 0;
            z-index: 200;
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        
        /* åˆ—å°æ¨£å¼ */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // æ¬Šé™è¨­å®š
        const ADMIN_EMAIL = "dream17dream17petshop@gmail.com";
        const STAFF_EMAIL = "staff@dream17.com";
        
        // ç‹€æ…‹è®Šé‡
        let state = {
            isSupabaseReady: false,
            supabase: null,
            session: null,
            loading: true,
            dataLoading: false,
            loginEmail: '',
            password: '',
            loginError: '',
            bookings: [],
            selectedBooking: null,
            selectedBookings: new Set(),
            searchFilter: '',
            statusFilter: 'all',
            serviceFilter: 'all',
            dateFrom: '',
            dateTo: '',
            viewMode: 'list',
            activeTab: 'orders',
            isEditing: false,
            editForm: {},
            showConfirm: false,
            confirmAction: null,
            actionLoading: false,
            showPasswordModal: false,
            toast: null,
            activityLogs: [],
            targetEmail: '', // ç”¨æ–¼ä¿®æ”¹å¯†ç¢¼
            oldPassword: '',
            newPassword: '',
            confirmPassword: ''
        };

        // DOM å…ƒç´ å¼•ç”¨
        const rootElement = document.getElementById('root');
        
        // å·¥å…·å‡½æ•¸
        const getServiceLabel = (serviceType, serviceTags) => {
            if (serviceTags && serviceTags.length > 0) {
                return serviceTags.join(', ');
            }
            if (!serviceType) return '';
            if (serviceType.includes('ä½å®¿')) return 'ğŸ  ä½å®¿ï¼‹æ´—æ¾¡';
            return `âœ‚ï¸ ${serviceType}`;
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString('zh-TW');
        };

        const formatDateTime = (dateStr) => {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleString('zh-TW');
        };

        const showToast = (message, type = 'success') => {
            state.toast = { message, type };
            render();
            setTimeout(() => {
                state.toast = null;
                render();
            }, 3000);
        };

        const addLog = (action, details) => {
            const newLog = { action, details, timestamp: new Date().toISOString() };
            state.activityLogs = [newLog, ...state.activityLogs].slice(0, 100);
            localStorage.setItem('activity_logs', JSON.stringify(state.activityLogs));
            render();
        };

        const getPermissions = (userEmail) => {
            const ADMIN_ROLES = {
                [ADMIN_EMAIL]: {
                    role: 'super_admin',
                    name: 'ç®¡ç†å“¡',
                    permissions: ['view', 'edit', 'delete', 'export', 'settings', 'logs', 'manage_admins']
                },
                [STAFF_EMAIL]: {
                    role: 'staff',
                    name: 'å“¡å·¥',
                    permissions: ['view'] 
                }
            };
            
            const adminConfig = ADMIN_ROLES[userEmail] || { role: 'viewer', permissions: ['view'] };
            
            const hasPermission = (permission) => {
                return adminConfig.permissions.includes(permission);
            };
            
            return {
                role: adminConfig.role,
                roleName: adminConfig.name,
                permissions: adminConfig.permissions,
                hasPermission,
                canEdit: () => hasPermission('edit'),
                canDelete: () => hasPermission('delete'),
                canExport: () => hasPermission('export'),
                canAccessSettings: () => hasPermission('settings'),
                canViewLogs: () => hasPermission('logs'),
                canManageAdmins: () => hasPermission('manage_admins')
            };
        };

        // ç²å–ç•¶å‰ç”¨æˆ¶æ¬Šé™
        const getCurrentPermissions = () => {
            return getPermissions(state.session?.user?.email);
        };

        // åˆå§‹åŒ– Supabase
        const initSupabase = () => {
            if (window.supabase) {
                const { createClient } = window.supabase;
                const client = createClient(
                    'https://gyqzsroxdqyzldqvulbs.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5cXpzcm94ZHF5emxkcXZ1bGJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2NjQyOTEsImV4cCI6MjA4NDI0MDI5MX0.vksBNZ0yxFwG7NBAlfJLs-qpAZGvCivpnpHcp7w5rl0'
                );
                state.supabase = client;
                state.isSupabaseReady = true;
                
                // æª¢æŸ¥æœƒè©±
                checkSession();
                
                // è¨­ç½®èªè­‰ç‹€æ…‹ç›£è½å™¨
                setupAuthListener();
                
                // è¼‰å…¥æ—¥èªŒ
                loadActivityLogs();
                
                render();
            } else {
                console.error("Supabase library not loaded yet.");
            }
        };

        // æª¢æŸ¥æœƒè©±
        const checkSession = async () => {
            if (!state.supabase) return;
            const { data: { session } } = await state.supabase.auth.getSession();
            state.session = session;
            if (session) fetchBookings();
            state.loading = false;
            render();
        };

        // è¨­ç½®èªè­‰ç‹€æ…‹ç›£è½å™¨
        const setupAuthListener = () => {
            if (!state.supabase) return;
            const { data: { subscription } } = state.supabase.auth.onAuthStateChange((_event, session) => {
                state.session = session;
                if (session) fetchBookings();
                render();
            });
            return () => subscription.unsubscribe();
        };

        // è¼‰å…¥æ´»å‹•æ—¥èªŒ
        const loadActivityLogs = () => {
            const saved = localStorage.getItem('activity_logs');
            if (saved) state.activityLogs = JSON.parse(saved);
        };

        // è™•ç†ç™»å…¥ - ä¿®æ­£ç‰ˆ
        const handleLogin = async (e) => {
            e.preventDefault();
            if (!state.supabase || !state.supabase.auth) {
                alert('ç³»çµ±å°šæœªæº–å‚™å¥½ï¼Œè«‹ç¨å¾Œå†è©¦');
                return;
            }
            
            // ç²å–å¯†ç¢¼è¼¸å…¥æ¡†çš„å€¼
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                state.password = passwordInput.value;
            }
            
            if (!state.password) {
                state.loginError = 'è«‹è¼¸å…¥å¯†ç¢¼';
                render();
                return;
            }
            
            state.loading = true;
            state.loginError = '';
            render();
            
            try {
                const { data, error } = await state.supabase.auth.signInWithPassword({
                    email: state.loginEmail,
                    password: state.password, 
                });
                
                if (error) {
                    state.loginError = error.message;
                    throw error;
                }
                
                // ç™»å…¥æˆåŠŸå¾Œé‡ç½®å¯†ç¢¼æ¬„ä½
                state.password = '';
                
            } catch (error) {
                console.error('Login error:', error);
            } finally {
                state.loading = false;
                render();
            }
        };

        // è™•ç†ç™»å‡º
        const handleLogout = async () => {
            addLog('ç™»å‡º', 'ä½¿ç”¨è€…ç™»å‡º');
            await state.supabase.auth.signOut();
            window.location.href = 'index.html';
        };

        // ç²å–è¨‚å–®æ•¸æ“š
        const fetchBookings = async () => {
            state.dataLoading = true;
            render();
            
            const { data, error } = await state.supabase.from('bookings').select('*').order('created_at', { ascending: false });
            if (!error) {
                state.bookings = data;
                
                // è¨­ç½®å¯¦æ™‚ç›£è½
                setupRealtimeListener();
            }
            
            state.dataLoading = false;
            render();
        };

        // è¨­ç½®å¯¦æ™‚ç›£è½
        const setupRealtimeListener = () => {
            if (!state.session || !state.supabase) return;
            
            const channel = state.supabase
                .channel('bookings-changes')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'bookings' }, (payload) => {
                    state.bookings = [payload.new, ...state.bookings];
                    showToast(`ğŸ‰ æ–°è¨‚å–®ï¼${payload.new.pet_name} - ${payload.new.owner_name}`, 'success');
                    addLog('æ–°è¨‚å–®', `#${payload.new.id} ${payload.new.pet_name}`);
                    render();
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'bookings' }, (payload) => {
                    state.bookings = state.bookings.map(b => b.id === payload.new.id ? payload.new : b);
                    render();
                })
                .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'bookings' }, (payload) => {
                    state.bookings = state.bookings.filter(b => b.id !== payload.old.id);
                    render();
                })
                .subscribe();
                
            return () => { state.supabase.removeChannel(channel); };
        };

        // æ›´æ–°è¨‚å–®ç‹€æ…‹
        const updateStatus = async (id, newStatus) => {
            const currentBooking = state.bookings.find(b => b.id === id);
            const oldStatus = currentBooking?.status || 'pending';
            if (oldStatus === newStatus) return;
            
            const newHistoryEntry = {
                from: oldStatus,
                to: newStatus,
                changed_at: new Date().toISOString(),
                changed_by: state.session?.user?.email || 'unknown'
            };
            
            const updatedRawData = {
                ...currentBooking?.raw_data,
                status_history: [...(currentBooking?.raw_data?.status_history || []), newHistoryEntry]
            };
            
            const { data, error } = await state.supabase
                .from('bookings')
                .update({ status: newStatus, raw_data: updatedRawData })
                .eq('id', id)
                .select();
            
            if (!error && data) {
                const updatedBooking = data[0];
                state.bookings = state.bookings.map(b => b.id === id ? updatedBooking : b);
                if (state.selectedBooking?.id === id) state.selectedBooking = updatedBooking;
                addLog('ç‹€æ…‹æ›´æ–°', `#${id} ${oldStatus} â†’ ${newStatus}`);
                showToast('ç‹€æ…‹å·²æ›´æ–°', 'success');
                render();
            } else {
                showToast('ç‹€æ…‹æ›´æ–°å¤±æ•—', 'error');
            }
        };

        // æ‰¹æ¬¡æ›´æ–°ç‹€æ…‹
        const handleBatchStatusUpdate = async (newStatus) => {
            if (state.selectedBookings.size === 0) return;
            const ids = Array.from(state.selectedBookings);
            const { error } = await state.supabase.from('bookings').update({ status: newStatus }).in('id', ids);
            if (!error) {
                state.bookings = state.bookings.map(b => ids.includes(b.id) ? { ...b, status: newStatus } : b);
                state.selectedBookings = new Set();
                addLog('æ‰¹æ¬¡æ›´æ–°', `${ids.length} ç­†è¨‚å–® â†’ ${newStatus}`);
                showToast(`å·²æ›´æ–° ${ids.length} ç­†è¨‚å–®`, 'success');
                render();
            }
        };

        // åˆ‡æ›é¸æ“‡è¨‚å–®
        const toggleSelectBooking = (id) => {
            if (state.selectedBookings.has(id)) {
                state.selectedBookings.delete(id);
            } else {
                state.selectedBookings.add(id);
            }
            render();
        };

        // å…¨é¸è¨‚å–®
        const selectAllBookings = () => {
            const filteredBookings = getFilteredBookings();
            if (state.selectedBookings.size === filteredBookings.length) {
                state.selectedBookings = new Set();
            } else {
                state.selectedBookings = new Set(filteredBookings.map(b => b.id));
            }
            render();
        };

        // è§¸ç™¼å‹•ä½œ
        const triggerAction = (action) => { 
            const permissions = getCurrentPermissions();
            
            if (action === 'save' && !permissions.canEdit()) {
                showToast("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•ç·¨è¼¯", "error");
                return;
            }
            if (action === 'delete' && !permissions.canDelete()) {
                showToast("æ¬Šé™ä¸è¶³ï¼šç„¡æ³•åˆªé™¤", "error");
                return;
            }
            state.confirmAction = action; 
            state.showConfirm = true; 
            render();
        };

        // åŸ·è¡Œå‹•ä½œ
        const executeAction = async (confirmPassword) => {
            state.actionLoading = true;
            render();
            
            // é©—è­‰ç•¶å‰ç™»å…¥è€…çš„å¯†ç¢¼
            const { error: authError } = await state.supabase.auth.signInWithPassword({ 
                email: state.loginEmail, 
                password: confirmPassword 
            });
            
            if (authError) { 
                showToast("å¯†ç¢¼éŒ¯èª¤", 'error'); 
                state.actionLoading = false; 
                render();
                return; 
            }

            if (state.confirmAction === 'save') {
                const permissions = getCurrentPermissions();
                if (permissions.canEdit()) await handleSaveLogic();
                else showToast("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•å„²å­˜", 'error');
            }
            else if (state.confirmAction === 'delete') {
                const permissions = getCurrentPermissions();
                if (permissions.canDelete()) await handleDeleteLogic();
                else showToast("æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•åˆªé™¤", 'error');
            }
            
            state.actionLoading = false; 
            state.showConfirm = false;
            render();
        };

        // åˆªé™¤è¨‚å–®é‚è¼¯
        const handleDeleteLogic = async () => {
            const { error } = await state.supabase.from('bookings').delete().eq('id', state.selectedBooking.id);
            if (!error) {
                state.bookings = state.bookings.filter(b => b.id !== state.selectedBooking.id);
                addLog('åˆªé™¤è¨‚å–®', `#${state.selectedBooking.id} ${state.selectedBooking.pet_name}`);
                state.selectedBooking = null;
                showToast('è¨‚å–®å·²åˆªé™¤', 'success');
                render();
            } else { 
                showToast("åˆªé™¤å¤±æ•—", 'error'); 
            }
        };

        // é–‹å§‹ç·¨è¼¯
        const startEditing = () => {
            const permissions = getCurrentPermissions();
            if (!permissions.canEdit()) {
                showToast("æ‚¨æ²’æœ‰æ¬Šé™åŸ·è¡Œæ­¤æ“ä½œ", "error");
                return;
            }
            state.editForm = { ...state.selectedBooking, ...state.selectedBooking.raw_data };
            state.isEditing = true;
            render();
        };

        // è™•ç†ç·¨è¼¯è®Šæ›´
        const handleEditChange = (field, value) => { 
            state.editForm[field] = value;
            render();
        };

        // å„²å­˜é‚è¼¯
        const handleSaveLogic = async () => {
            const sanitizeDate = (val) => (!val || val === '') ? null : val;
            const topLevelUpdates = {
                owner_name: state.editForm.owner_name,
                phone: state.editForm.phone,
                pet_name: state.editForm.pet_name,
                service_type: state.editForm.service_type,
                checkin_date: sanitizeDate(state.editForm.checkin_date),
                checkout_date: sanitizeDate(state.editForm.checkout_date),
                pickup_time: state.editForm.pickup_time,
                service_price: state.editForm.service_price
            };
            const newRawData = { ...state.selectedBooking.raw_data, ...state.editForm };
            ['id', 'created_at', 'status', 'raw_data', 'signature_url', 'vaccine_url'].forEach(k => delete newRawData[k]);

            const { data, error } = await state.supabase.from('bookings')
                .update({ ...topLevelUpdates, raw_data: newRawData })
                .eq('id', state.selectedBooking.id)
                .select();

            if (!error && data) {
                const updatedBooking = data[0];
                state.bookings = state.bookings.map(b => b.id === updatedBooking.id ? updatedBooking : b);
                state.selectedBooking = updatedBooking;
                state.isEditing = false;
                addLog('ç·¨è¼¯è¨‚å–®', `#${updatedBooking.id} ${updatedBooking.pet_name}`);
                showToast('å„²å­˜æˆåŠŸ', 'success');
                render();
            } else { 
                showToast("å„²å­˜å¤±æ•—", 'error'); 
            }
        };

        // åŒ¯å‡º Excel
        const exportToExcel = (bookings, filename = 'bookings') => {
            const data = bookings.map(b => ({
                'è¨‚å–®ç·¨è™Ÿ': b.id,
                'å»ºç«‹æ™‚é–“': formatDateTime(b.created_at),
                'é£¼ä¸»å§“å': b.owner_name,
                'é›»è©±': b.phone,
                'å¯µç‰©åå­—': b.pet_name,
                'æœå‹™é …ç›®': b.service_tags?.join(', ') || b.service_type,
                'ç‹€æ…‹': b.status,
                'å…¥ä½æ—¥æœŸ': b.checkin_date || '',
                'é€€æˆ¿æ—¥æœŸ': b.checkout_date || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'è¨‚å–®');
            XLSX.writeFile(wb, `${filename}_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // ç²å–éæ¿¾å¾Œçš„è¨‚å–®
        const getFilteredBookings = () => {
            return state.bookings.filter(b => {
                if (state.searchFilter && !(
                    b.owner_name?.includes(state.searchFilter) || 
                    b.pet_name?.includes(state.searchFilter) || 
                    b.phone?.includes(state.searchFilter)
                )) return false;
                
                if (state.statusFilter !== 'all' && b.status !== state.statusFilter) return false;
                
                if (state.serviceFilter !== 'all') {
                    if (state.serviceFilter === 'boarding' && !b.service_tags?.includes('ä½å®¿') && b.view !== 'boarding') return false;
                    if (state.serviceFilter === 'grooming' && !b.service_tags?.includes('æ´—æ¾¡') && !b.service_tags?.includes('å‰ªæ¯›') && b.view !== 'grooming') return false;
                }
                
                if (state.dateFrom && b.created_at < state.dateFrom) return false;
                if (state.dateTo && b.created_at > state.dateTo + 'T23:59:59') return false;
                
                return true;
            });
        };

        // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
        const getStats = () => {
            const today = new Date().toISOString().split('T')[0];
            return {
                today: state.bookings.filter(b => b.created_at?.startsWith(today)).length,
                pending: state.bookings.filter(b => b.status === 'pending').length,
                boarding: state.bookings.filter(b => b.service_tags?.includes('ä½å®¿') || b.view === 'boarding').length,
                grooming: state.bookings.filter(b => 
                    b.service_tags?.includes('æ´—æ¾¡') || 
                    b.service_tags?.includes('å‰ªæ¯›') || 
                    b.view === 'grooming'
                ).length,
                daycare: state.bookings.filter(b => b.service_tags?.includes('å®‰è¦ª')).length,
                total: state.bookings.length
            };
        };

        // æ¸²æŸ“å‡½æ•¸
        const render = () => {
            // åˆå§‹åŒ– Lucide åœ–æ¨™
            if (typeof window.lucide !== 'undefined') {
                window.lucide.createIcons();
            }
            
            // å¦‚æœ Supabase é‚„æ²’å¥½ï¼Œé¡¯ç¤ºè¼‰å…¥ä¸­
            if (!state.isSupabaseReady) {
                rootElement.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-dream-cream">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-dream-navy mx-auto mb-4"></div>
                            <p class="text-dream-navy font-bold">ç³»çµ±è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                `;
                return;
            }

            // å¦‚æœæ²’æœ‰æœƒè©±ï¼Œé¡¯ç¤ºç™»å…¥é é¢
            if (!state.session) {
                renderLoginPage();
                return;
            }

            // é¡¯ç¤ºä¸»æ‡‰ç”¨ç¨‹åº
            renderMainApp();
        };

        // æ¸²æŸ“ç™»å…¥é é¢
        const renderLoginPage = () => {
            const permissions = getPermissions(state.loginEmail);
            
            rootElement.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center p-6 relative">
                    <div class="absolute top-[10%] left-[-10%] w-72 h-72 bg-dream-gold opacity-10 rounded-full blur-[80px] animate-blob"></div>
                    <div class="absolute bottom-[10%] right-[-10%] w-80 h-80 bg-dream-navy opacity-[0.07] rounded-full blur-[100px] animate-blob" style="animation-delay: '3s'"></div>
                    <div class="w-full max-w-[500px] flex flex-col items-center z-10 p-6 md:p-8 rounded-[40px] glass-panel animate-fade-up">
                        <header class="flex flex-col items-center mb-6 text-center">
                            <img src="logo.png" class="w-56 h-auto object-contain mb-4 hover:scale-105 transition-transform duration-500" alt="Dream 17" />
                            <div class="space-y-0.5">
                                <h1 class="text-xl font-bold tracking-[0.1em] text-dream-navy">å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨</h1>
                                <p class="text-[10px] text-dream-gold font-bold tracking-[0.3em] uppercase opacity-80">Forever Family</p>
                            </div>
                        </header>
                        ${!state.loginEmail ? `
                            <div class="space-y-4 w-full">
                                <p class="text-center text-gray-500 text-sm mb-8">è«‹é¸æ“‡ç™»å…¥èº«åˆ†</p>
                                <button data-action="set-login-email" data-email="${ADMIN_EMAIL}" class="glass-button group w-full p-5 rounded-[24px] flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-5 relative z-10">
                                        <div class="w-14 h-14 flex items-center justify-center rounded-[20px] bg-white text-dream-navy shadow-[0_4px_20px_rgba(235,235,235,1)] group-hover:scale-110 transition-transform duration-500">
                                            <i data-lucide="shield" width="24" height="24"></i>
                                        </div>
                                        <div class="text-left space-y-0.5">
                                            <span class="text-[10px] font-bold text-dream-gold tracking-[0.2em] uppercase">Admin</span>
                                            <h3 class="font-bold text-[19px] text-dream-navy group-hover:text-dream-gold/90 transition-colors">ç®¡ç†å“¡ç™»å…¥</h3>
                                            <p class="text-[12px] text-gray-400 font-medium tracking-wide">æ“æœ‰å®Œæ•´æ¬Šé™</p>
                                        </div>
                                    </div>
                                    <div class="text-dream-gold/30 group-hover:text-dream-gold group-hover:translate-x-1 transition-all duration-300 relative z-10">
                                        <i data-lucide="arrow-right" width="20" height="20"></i>
                                    </div>
                                </button>
                                <button data-action="set-login-email" data-email="${STAFF_EMAIL}" class="glass-button group w-full p-5 rounded-[24px] flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-5 relative z-10">
                                        <div class="w-14 h-14 flex items-center justify-center rounded-[20px] bg-white text-dream-navy shadow-[0_4px_20px_rgba(235,235,235,1)] group-hover:scale-110 transition-transform duration-500">
                                            <i data-lucide="user" width="24" height="24"></i>
                                        </div>
                                        <div class="text-left space-y-0.5">
                                            <span class="text-[10px] font-bold text-dream-gold tracking-[0.2em] uppercase">Staff</span>
                                            <h3 class="font-bold text-[19px] text-dream-navy group-hover:text-dream-gold/90 transition-colors">å“¡å·¥ç™»å…¥</h3>
                                            <p class="text-[12px] text-gray-400 font-medium tracking-wide">åƒ…é™æª¢è¦–</p>
                                        </div>
                                    </div>
                                    <div class="text-dream-gold/30 group-hover:text-dream-gold group-hover:translate-x-1 transition-all duration-300 relative z-10">
                                        <i data-lucide="arrow-right" width="20" height="20"></i>
                                    </div>
                                </button>
                            </div>
                        ` : `
                            <form id="loginForm" class="space-y-4 w-full fade-in">
                                <div class="text-center mb-6">
                                    <span class="inline-block px-4 py-1 rounded-full text-xs font-bold mb-2 ${state.loginEmail === ADMIN_EMAIL ? 'bg-dream-navy text-white' : 'bg-blue-500 text-white'}">
                                        ${state.loginEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}
                                    </span>
                                    <p class="text-lg font-bold text-dream-navy">${state.loginEmail === ADMIN_EMAIL ? 'æ­¡è¿å›ä¾†ï¼Œåº—é•·ï¼' : 'ä¸Šç­åŠ æ²¹ï¼'}</p>
                                </div>
                                <div class="relative">
                                    <i data-lucide="lock" width="20" height="20" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                    <input type="password" id="passwordInput" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" class="w-full pl-12 pr-4 py-4 rounded-xl glass-input text-lg font-bold text-center tracking-widest placeholder:tracking-normal" autofocus />
                                </div>
                                ${state.loginError ? `<p class="text-dream-red text-sm font-bold animate-pulse text-center">${state.loginError}</p>` : ''}
                                <button type="submit" id="loginButton" data-action="login" disabled="${state.loading}" class="w-full py-4 rounded-[24px] bg-dream-navy text-white text-lg font-bold shadow-xl shadow-dream-navy/30 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                                    ${state.loading ? '<i data-lucide="loader-2" class="animate-spin"></i>' : 'ç¢ºèªç™»å…¥ <i data-lucide="arrow-right" width="20" height="20"></i>'}
                                </button>
                                <button type="button" data-action="reset-login" class="w-full py-2 text-gray-400 hover:text-dream-navy text-sm font-bold transition-colors">
                                    â† åˆ‡æ›ä½¿ç”¨è€…
                                </button>
                            </form>
                        `}
                        <div class="mt-6 border-t border-white/50 pt-4">
                            <a href="index.html" class="w-full py-3 rounded-xl font-bold text-gray-400 hover:text-dream-navy transition-all flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="arrow-left" width="16" height="16"></i> è¿”å›å¡«å¯«é¦–é 
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            // åˆå§‹åŒ– Lucide åœ–æ¨™
            if (typeof window.lucide !== 'undefined') {
                window.lucide.createIcons();
            }
            
            // å¦‚æœæœ‰å¯†ç¢¼è¼¸å…¥æ¡†ï¼Œè¨­ç½®ç„¦é»
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.focus();
            }
        };

        // è¨­ç½®ç™»å…¥éƒµç®±
        const setLoginEmail = (email) => {
            state.loginEmail = email;
            state.password = '';
            state.loginError = '';
            render();
        };

        // é‡ç½®ç™»å…¥
        const resetLogin = () => {
            state.loginEmail = '';
            state.password = '';
            state.loginError = '';
            render();
        };

        // æ¸²æŸ“ä¸»æ‡‰ç”¨ç¨‹åº
        const renderMainApp = () => {
            const permissions = getCurrentPermissions();
            const stats = getStats();
            const filteredBookings = getFilteredBookings();
            
            rootElement.innerHTML = `
                <div class="min-h-screen bg-dream-cream pb-32">
                    ${state.toast ? `
                        <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[200] px-6 py-4 rounded-2xl shadow-2xl flex items-center gap-3 transition-all duration-300 ${
                            state.toast.type === 'success' ? 'bg-dream-line text-white' : 
                            state.toast.type === 'error' ? 'bg-dream-red text-white' : 
                            'bg-dream-gold text-white'
                        }">
                            <div class="flex-shrink-0">
                                ${state.toast.type === 'success' ? 
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>' : 
                                    state.toast.type === 'error' ? 
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' : 
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
                                }
                            </div>
                            <p class="font-bold text-sm">${state.toast.message}</p>
                        </div>
                    ` : ''}
                    
                    <nav class="glass-nav fixed top-0 left-0 w-full z-40 transition-all duration-300 py-3">
                        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <img src="logo.png" class="h-10" alt="Logo" />
                                <span class="font-bold text-lg text-dream-navy tracking-widest">å¾Œå°ç®¡ç†</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button data-action="fetch-bookings" class="p-2 rounded-full hover:bg-white/60 text-dream-navy transition-colors">
                                    <i data-lucide="rotate-cw" width="20" height="20" class="${state.dataLoading ? 'animate-spin' : ''}"></i>
                                </button>
                                ${permissions.canManageAdmins() ? `
                                    <button data-action="show-password-modal" class="p-2 rounded-full hover:bg-white/60 text-dream-navy transition-colors">
                                        <i data-lucide="key" width="20" height="20"></i>
                                    </button>
                                ` : ''}
                                <button data-action="logout" class="p-2 rounded-full hover:bg-red-50 text-dream-navy hover:text-dream-red transition-colors">
                                    <i data-lucide="log-out" width="20" height="20"></i>
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main class="pt-24 px-4 max-w-7xl mx-auto space-y-6 animate-fade-in">
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
                            ${[
                                { title: 'ä»Šæ—¥æ–°å¢', count: stats.today, icon: 'plus-circle', bgColor: 'bg-blue-50', textColor: 'text-blue-500' },
                                { title: 'å¾…è™•ç†', count: stats.pending, icon: 'alert-circle', bgColor: 'bg-yellow-50', textColor: 'text-yellow-500' },
                                { title: 'ä½å®¿é ç´„', count: stats.boarding, icon: 'home', bgColor: 'bg-orange-50', textColor: 'text-orange-500' },
                                { title: 'æ´—æ¾¡ç¾å®¹', count: stats.grooming, icon: 'scissors', bgColor: 'bg-pink-50', textColor: 'text-pink-500' },
                                { title: 'å¯µç‰©å®‰è¦ª', count: stats.daycare, icon: 'sun', bgColor: 'bg-teal-50', textColor: 'text-teal-500' },
                                { title: 'ç¸½è¨‚å–®æ•¸', count: stats.total, icon: 'file-text', bgColor: 'bg-purple-50', textColor: 'text-purple-500' }
                            ].map((item, idx) => `
                                <div key="${idx}" class="glass-panel p-4 rounded-2xl flex flex-col justify-between h-28">
                                    <div class="flex justify-between items-start">
                                        <div class="text-xs text-gray-500 font-bold uppercase tracking-wider">${item.title}</div>
                                        <div class="${item.bgColor} ${item.textColor} p-1.5 rounded-lg"><i data-lucide="${item.icon}" width="16" height="16"></i></div>
                                    </div>
                                    <div class="text-2xl font-black text-dream-navy">${item.count}</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Tabs -->
                        <div class="flex gap-1 border-b border-white/50 overflow-x-auto">
                            <button data-action="set-active-tab" data-tab="orders" class="px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${state.activeTab === 'orders' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}">
                                <i data-lucide="clipboard-list" width="16" height="16"></i> è¨‚å–®ç®¡ç†
                            </button>
                            <button data-action="set-active-tab" data-tab="dashboard" class="px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${state.activeTab === 'dashboard' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}">
                                <i data-lucide="bar-chart-2" width="16" height="16"></i> æ•¸æ“šå„€è¡¨æ¿
                            </button>
                            ${permissions.canViewLogs() ? `
                                <button data-action="set-active-tab" data-tab="logs" class="px-4 py-3 font-bold text-sm flex items-center gap-2 transition-colors ${state.activeTab === 'logs' ? 'border-b-3 border-dream-navy text-dream-navy' : 'text-gray-400 hover:text-dream-navy'}">
                                    <i data-lucide="activity" width="16" height="16"></i> æ“ä½œæ—¥èªŒ
                                </button>
                            ` : ''}
                        </div>

                        <!-- Content -->
                        ${state.activeTab === 'orders' ? renderOrdersTab(filteredBookings, permissions) : ''}
                        ${state.activeTab === 'dashboard' ? renderDashboardTab() : ''}
                        ${state.activeTab === 'logs' ? renderLogsTab() : ''}
                    </main>

                    <!-- Booking Detail Modal -->
                    ${state.selectedBooking ? renderBookingDetailModal(permissions) : ''}
                    
                    <!-- Change Password Modal -->
                    ${state.showPasswordModal ? renderChangePasswordModal() : ''}
                    
                    <!-- Confirm Modal -->
                    ${state.showConfirm ? renderConfirmModal() : ''}
                </div>
            `;
            
            // åˆå§‹åŒ– Lucide åœ–æ¨™
            if (typeof window.lucide !== 'undefined') {
                window.lucide.createIcons();
            }
            
            // å¦‚æœæ˜¯å„€è¡¨æ¿ï¼Œåˆå§‹åŒ–åœ–è¡¨
            if (state.activeTab === 'dashboard') {
                initDashboardCharts();
            }
        };

        // æ¸²æŸ“è¨‚å–®æ¨™ç±¤é 
        const renderOrdersTab = (filteredBookings, permissions) => {
            return `
                <div class="space-y-4">
                    <div class="glass-panel p-4 rounded-2xl">
                        <div class="flex flex-wrap gap-3">
                            <div class="relative flex-1 min-w-[200px]">
                                <i data-lucide="search" width="16" height="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                                <input type="text" id="searchInput" placeholder="æœå°‹é›»è©±ã€å¯µç‰©åã€é£¼ä¸»..." value="${state.searchFilter}" class="w-full pl-10 pr-4 py-2 rounded-lg glass-input text-sm" />
                            </div>
                            <select id="statusFilter" onchange="state.statusFilter = this.value" class="px-3 py-2 rounded-lg glass-input text-sm font-bold">
                                <option value="all" ${state.statusFilter === 'all' ? 'selected' : ''}>å…¨éƒ¨ç‹€æ…‹</option>
                                <option value="pending" ${state.statusFilter === 'pending' ? 'selected' : ''}>å¾…è™•ç†</option>
                                <option value="confirmed" ${state.statusFilter === 'confirmed' ? 'selected' : ''}>å·²ç¢ºèª</option>
                                <option value="completed" ${state.statusFilter === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
                                <option value="cancelled" ${state.statusFilter === 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
                            </select>
                            <select id="serviceFilter" onchange="state.serviceFilter = this.value" class="px-3 py-2 rounded-lg glass-input text-sm font-bold">
                                <option value="all" ${state.serviceFilter === 'all' ? 'selected' : ''}>å…¨éƒ¨æœå‹™</option>
                                <option value="boarding" ${state.serviceFilter === 'boarding' ? 'selected' : ''}>ğŸ  ä½å®¿</option>
                                <option value="grooming" ${state.serviceFilter === 'grooming' ? 'selected' : ''}>âœ‚ï¸ ç¾å®¹</option>
                            </select>
                            <input type="date" id="dateFrom" value="${state.dateFrom}" onchange="state.dateFrom = this.value" class="px-3 py-2 rounded-lg glass-input text-sm" />
                            <input type="date" id="dateTo" value="${state.dateTo}" onchange="state.dateTo = this.value" class="px-3 py-2 rounded-lg glass-input text-sm" />
                        </div>
                        
                        <div class="flex justify-between items-center mt-4 pt-4 border-t border-white/50">
                            <div class="flex gap-2">
                                ${['list', 'calendar', 'crm'].map(mode => `
                                    <button data-action="set-view-mode" data-mode="${mode}" class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${state.viewMode === mode ? 'bg-dream-navy text-white' : 'bg-white/60 text-gray-500 hover:bg-white'}">
                                        <i data-lucide="${mode === 'list' ? 'list' : mode === 'calendar' ? 'calendar' : 'users'}" width="14" height="14" class="inline mr-1"></i>
                                        ${mode === 'list' ? 'åˆ—è¡¨' : mode === 'calendar' ? 'æ—¥æ›†' : 'CRM'}
                                    </button>
                                `).join('')}
                            </div>
                            <div class="flex gap-2">
                                ${state.selectedBookings.size > 0 ? `
                                    <span class="text-xs text-gray-500 self-center">å·²é¸ ${state.selectedBookings.size} ç­†</span>
                                    <select id="batchStatus" onchange="if(this.value) handleBatchStatusUpdate(this.value); this.value = '';" class="px-2 py-1 rounded-lg glass-input text-xs font-bold">
                                        <option value="">æ‰¹æ¬¡æ›´æ”¹ç‹€æ…‹...</option>
                                        <option value="pending">å¾…è™•ç†</option>
                                        <option value="confirmed">å·²ç¢ºèª</option>
                                        <option value="completed">å·²å®Œæˆ</option>
                                        <option value="cancelled">å·²å–æ¶ˆ</option>
                                    </select>
                                ` : ''}
                                ${permissions.canExport() ? `
                                    <button data-action="export-excel" class="px-3 py-1.5 rounded-lg bg-green-50 text-green-600 text-xs font-bold hover:bg-green-100 transition-colors flex items-center gap-1">
                                        <i data-lucide="file-spreadsheet" width="14" height="14"></i> åŒ¯å‡º Excel
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    ${state.dataLoading ? `
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${[1,2,3,4,5,6].map(i => `
                                <div class="glass-panel p-4 rounded-2xl animate-pulse">
                                    <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
                                    <div class="h-3 bg-gray-200 rounded w-1/2 mb-4"></div>
                                    <div class="space-y-2">
                                        <div class="h-3 bg-gray-200 rounded"></div>
                                        <div class="h-3 bg-gray-200 rounded w-5/6"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : state.viewMode === 'calendar' ? renderCalendarView(filteredBookings) : 
                       state.viewMode === 'crm' ? renderCRMView(filteredBookings) : 
                       renderListView(filteredBookings)}
                </div>
            `;
        };

        // æ¸²æŸ“åˆ—è¡¨è¦–åœ–
        const renderListView = (filteredBookings) => {
            return `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="md:hidden p-4 space-y-3">
                        ${filteredBookings.map(b => `
                            <div class="bg-white/60 p-4 rounded-xl flex items-center gap-3">
                                <input type="checkbox" data-action="toggle-select-booking" data-id="${b.id}" ${state.selectedBookings.has(b.id) ? 'checked' : ''} class="w-5 h-5 accent-dream-navy" />
                                <div class="flex-1" data-action="select-booking" data-id="${b.id}">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-dream-navy">${b.pet_name}</span>
                                        ${renderStatusBadge(b.status)}
                                    </div>
                                    <div class="text-xs text-gray-500">${b.owner_name} â€¢ ${getServiceLabel(b.service_type, b.service_tags)}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-gray-400">${formatDate(b.created_at)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="hidden md:block overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-white/40 text-gray-500 font-bold text-xs uppercase tracking-wider">
                                <tr>
                                    <th class="px-4 py-3">
                                        <input type="checkbox" data-action="select-all-bookings" ${state.selectedBookings.size === filteredBookings.length && filteredBookings.length > 0 ? 'checked' : ''} class="w-4 h-4 accent-dream-navy" />
                                    </th>
                                    <th class="px-4 py-3">å»ºç«‹æ™‚é–“</th>
                                    <th class="px-4 py-3">é£¼ä¸» / é›»è©±</th>
                                    <th class="px-4 py-3">å¯µç‰©</th>
                                    <th class="px-4 py-3">æœå‹™é …ç›®</th>
                                    <th class="px-4 py-3">ç‹€æ…‹</th>
                                    <th class="px-4 py-3"></th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/50">
                                ${filteredBookings.map(b => `
                                    <tr class="hover:bg-dream-gold/5 transition-colors cursor-pointer group">
                                        <td class="px-4 py-3">
                                            <input type="checkbox" data-action="toggle-select-booking" data-id="${b.id}" ${state.selectedBookings.has(b.id) ? 'checked' : ''} class="w-4 h-4 accent-dream-navy" />
                                        </td>
                                        <td class="px-4 py-3 text-sm" data-action="select-booking" data-id="${b.id}">
                                            <div class="font-medium text-gray-600">${formatDate(b.created_at)}</div>
                                            <div class="text-xs text-gray-400">${new Date(b.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                        </td>
                                        <td class="px-4 py-3" data-action="select-booking" data-id="${b.id}">
                                            <div class="font-bold text-dream-navy">${b.owner_name}</div>
                                            <div class="text-xs text-gray-400">${b.phone}</div>
                                        </td>
                                        <td class="px-4 py-3" data-action="select-booking" data-id="${b.id}">
                                            <span class="bg-dream-navy/10 text-dream-navy px-2 py-1 rounded text-xs font-bold">${b.pet_name}</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm font-bold text-gray-600" data-action="select-booking" data-id="${b.id}">
                                            ${getServiceLabel(b.service_type, b.service_tags)}
                                        </td>
                                        <td class="px-4 py-3" data-action="select-booking" data-id="${b.id}">
                                            ${renderStatusBadge(b.status)}
                                        </td>
                                        <td class="px-4 py-3">
                                            <button data-action="select-booking" data-id="${b.id}" class="text-gray-300 group-hover:text-dream-navy transition-colors">
                                                <i data-lucide="chevron-right" width="18" height="18"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${filteredBookings.length === 0 ? '<tr><td colspan="8" class="px-6 py-20 text-center text-gray-400">æ²’æœ‰æ‰¾åˆ°ç›¸é—œè¨‚å–®</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“æ—¥æ›†è¦–åœ–
        const renderCalendarView = (bookings) => {
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const days = [];
            for (let i = 0; i < startDay; i++) days.push(null);
            for (let i = 1; i <= daysInMonth; i++) days.push(i);
            
            const getBookingsForDay = (day) => {
                if (!day) return [];
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                return bookings.filter(b => {
                    if (b.checkin_date && b.checkout_date) {
                        return dateStr >= b.checkin_date && dateStr <= b.checkout_date;
                    }
                    return b.created_at?.startsWith(dateStr);
                });
            };

            return `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/50 flex justify-between items-center bg-white/40">
                        <button data-action="prev-month" class="p-2 hover:bg-white/60 rounded-lg transition-colors">
                            <i data-lucide="chevron-left" width="20" height="20"></i>
                        </button>
                        <div class="flex items-center gap-3">
                            <h3 class="text-lg font-bold text-dream-navy">
                                ${year} å¹´ ${month + 1} æœˆ
                            </h3>
                            <button data-action="go-today" class="text-xs bg-dream-navy text-white px-3 py-1 rounded-full font-bold hover:bg-[#4A3D35] transition-colors">
                                ä»Šå¤©
                            </button>
                        </div>
                        <button data-action="next-month" class="p-2 hover:bg-white/60 rounded-lg transition-colors">
                            <i data-lucide="chevron-right" width="20" height="20"></i>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-7 border-b border-white/50">
                        ${['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => `
                            <div class="p-2 text-center text-xs font-bold text-gray-500 bg-white/40">
                                ${d}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="grid grid-cols-7">
                        ${days.map((day, idx) => {
                            const dayBookings = getBookingsForDay(day);
                            const isToday = day && new Date().toDateString() === new Date(year, month, day).toDateString();
                            
                            return `
                                <div class="min-h-[80px] border-r border-b border-white/50 p-1 ${!day ? 'bg-white/20' : ''} ${isToday ? 'bg-dream-gold/20' : ''}">
                                    ${day ? `
                                        <div class="text-xs font-bold mb-1 ${isToday ? 'text-dream-navy' : 'text-gray-600'}">
                                            ${day}
                                        </div>
                                        <div class="space-y-1 max-h-16 overflow-y-auto">
                                            ${dayBookings.slice(0, 3).map(b => `
                                                <div data-action="select-booking" data-id="${b.id}" class="calendar-event truncate p-1 rounded text-[10px] cursor-pointer transition-transform hover:scale-105 ${
                                                    b.service_tags?.includes('ä½å®¿') || b.view === 'boarding'
                                                        ? 'bg-orange-100 text-orange-700' 
                                                        : 'bg-blue-100 text-blue-700'
                                                }">
                                                    ${b.pet_name}
                                                </div>
                                            `).join('')}
                                            ${dayBookings.length > 3 ? `
                                                <div class="text-[10px] text-gray-400 text-center">
                                                    +${dayBookings.length - 3} æ›´å¤š
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“ CRM è¦–åœ–
        const renderCRMView = (bookings) => {
            const customers = {};
            bookings.forEach(b => {
                const phone = b.phone;
                if (!phone) return;
                if (!customers[phone]) {
                    customers[phone] = {
                        phone,
                        owner_name: b.owner_name,
                        email: b.raw_data?.email,
                        pets: new Set(),
                        bookings: [],
                        totalSpent: 0
                    };
                }
                customers[phone].bookings.push(b);
                customers[phone].totalSpent += parseInt(b.service_price) || 0;
                if (b.pet_name) customers[phone].pets.add(b.pet_name);
            });
            
            const customersArray = Object.values(customers).map(c => ({
                ...c,
                pets: Array.from(c.pets)
            })).sort((a, b) => b.bookings.length - a.bookings.length);
            
            return `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/50 bg-white/40">
                        <div class="flex items-center gap-3">
                            <i data-lucide="users" width="20" height="20" class="text-dream-navy"></i>
                            <h3 class="font-bold text-dream-navy">å®¢æˆ¶ç®¡ç† CRM</h3>
                        </div>
                        <div class="mt-3 relative">
                            <i data-lucide="search" width="16" height="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="crmSearchInput" placeholder="æœå°‹å®¢æˆ¶..." class="w-full pl-10 pr-4 py-2 rounded-lg glass-input text-sm" />
                        </div>
                    </div>
                    <div class="max-h-96 overflow-y-auto">
                        ${customersArray.map(customer => `
                            <div class="p-4 border-b border-white/50 hover:bg-white/60 transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-dream-navy">${customer.owner_name}</div>
                                        <div class="text-sm text-gray-500">${customer.phone}</div>
                                        <div class="flex flex-wrap gap-1 mt-2">
                                            ${customer.pets.map(pet => `
                                                <span class="text-xs bg-dream-gold/30 text-dream-navy px-2 py-0.5 rounded-full font-bold">
                                                    ğŸ• ${pet}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xs text-gray-500 font-bold bg-white px-2 py-1 rounded">${customer.bookings.length} ç­†è¨‚å–®</div>
                                    </div>
                                </div>
                                <div class="mt-3 flex gap-2">
                                    ${customer.bookings.slice(0, 3).map(b => `
                                        <button data-action="select-booking" data-id="${b.id}" class="text-xs bg-white/60 px-2 py-1 rounded hover:bg-white transition-colors">
                                            #${b.id}
                                        </button>
                                    `).join('')}
                                    ${customer.bookings.length > 3 ? `<span class="text-xs text-gray-400">+${customer.bookings.length - 3}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“ç‹€æ…‹æ¨™ç±¤
        const renderStatusBadge = (status) => {
            const statusConfig = {
                pending: { label: 'å¾…è™•ç†', bgColor: 'bg-yellow-100', textColor: 'text-yellow-700' },
                confirmed: { label: 'å·²ç¢ºèª', bgColor: 'bg-blue-100', textColor: 'text-blue-700' },
                completed: { label: 'å·²å®Œæˆ', bgColor: 'bg-green-100', textColor: 'text-green-700' },
                cancelled: { label: 'å·²å–æ¶ˆ', bgColor: 'bg-red-100', textColor: 'text-red-700' }
            };
            
            const config = statusConfig[status] || statusConfig.pending;
            
            return `
                <span class="px-2 py-1 rounded-full text-xs font-bold ${config.bgColor} ${config.textColor}">
                    ${config.label}
                </span>
            `;
        };

        // æ¸²æŸ“å„€è¡¨æ¿æ¨™ç±¤é 
        const renderDashboardTab = () => {
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass-panel p-4 rounded-2xl">
                            <h4 class="text-sm font-bold text-dream-navy mb-3">æœˆåº¦è¨‚å–®è¶¨å‹¢</h4>
                            <div class="h-40">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                        <div class="glass-panel p-4 rounded-2xl">
                            <h4 class="text-sm font-bold text-dream-navy mb-3">æœå‹™é¡å‹åˆ†ä½ˆ</h4>
                            <div class="h-40">
                                <canvas id="serviceChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // åˆå§‹åŒ–å„€è¡¨æ¿åœ–è¡¨
        const initDashboardCharts = () => {
            if (!state.bookings || state.bookings.length === 0) return;
            
            // æœˆåº¦è¶¨å‹¢åœ–è¡¨
            const monthlyData = {};
            state.bookings.forEach(b => {
                const month = b.created_at?.substring(0, 7);
                if (month) {
                    monthlyData[month] = (monthlyData[month] || 0) + 1;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
            
            const monthlyChartCanvas = document.getElementById('monthlyChart');
            if (monthlyChartCanvas) {
                new Chart(monthlyChartCanvas, {
                    type: 'line',
                    data: {
                        labels: sortedMonths.map(m => m.replace('-', '/')),
                        datasets: [{
                            label: 'è¨‚å–®æ•¸',
                            data: sortedMonths.map(m => monthlyData[m]),
                            borderColor: '#5C4D42',
                            backgroundColor: 'rgba(92, 77, 66, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // æœå‹™é¡å‹åˆ†ä½ˆåœ–è¡¨
            const serviceData = {};
            state.bookings.forEach(b => {
                const type = b.service_tags?.includes('ä½å®¿') || b.view === 'boarding' ? 'ä½å®¿' : 
                          b.service_tags?.includes('æ´—æ¾¡') || b.service_tags?.includes('å‰ªæ¯›') || b.view === 'grooming' ? 'ç¾å®¹' : 'å…¶ä»–';
                serviceData[type] = (serviceData[type] || 0) + 1;
            });

            const serviceChartCanvas = document.getElementById('serviceChart');
            if (serviceChartCanvas) {
                new Chart(serviceChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(serviceData),
                        datasets: [{
                            data: Object.values(serviceData),
                            backgroundColor: ['#C5A065', '#5C4D42', '#06C755', '#3b82f6', '#E05D5D', '#8b5cf6']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
        };

        // æ¸²æŸ“æ—¥èªŒæ¨™ç±¤é 
        const renderLogsTab = () => {
            return `
                <div class="glass-panel rounded-2xl overflow-hidden">
                    <div class="p-4 border-b border-white/50 bg-white/40 flex items-center gap-3">
                        <i data-lucide="activity" width="20" height="20" class="text-dream-navy"></i>
                        <h3 class="font-bold text-dream-navy">æ“ä½œæ—¥èªŒ</h3>
                    </div>
                    <div class="max-h-64 overflow-y-auto">
                        ${state.activityLogs.length === 0 ? `
                            <div class="p-8 text-center text-gray-400">æš«ç„¡æ“ä½œè¨˜éŒ„</div>
                        ` : state.activityLogs.map((log, idx) => `
                            <div class="p-3 border-b border-white/50 text-sm">
                                <div class="flex justify-between">
                                    <span class="font-bold text-dream-navy">${log.action}</span>
                                    <span class="text-xs text-gray-400">${formatDateTime(log.timestamp)}</span>
                                </div>
                                <div class="text-gray-500 text-xs mt-1">${log.details}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“è¨‚å–®è©³æƒ…æ¨¡æ…‹æ¡†
        const renderBookingDetailModal = (permissions) => {
            const booking = state.selectedBooking;
            const r = booking.raw_data || {};
            
            return `
                <div class="fixed inset-0 z-50 flex items-center justify-center p-0 md:p-4 bg-black/60 backdrop-blur-sm fade-in" data-action="close-booking-detail">
                    <div class="bg-white w-full h-full md:h-[90vh] md:max-w-5xl md:rounded-3xl shadow-2xl flex flex-col overflow-hidden">
                        <div class="px-6 py-4 border-b border-white/50 flex justify-between items-center bg-white/40 shrink-0">
                            <div>
                                <h2 class="text-xl font-black text-dream-navy">è¨‚å–® #${booking.id}</h2>
                                <p class="text-gray-400 text-xs">${state.isEditing ? 'ç·¨è¼¯æ¨¡å¼' : formatDateTime(booking.created_at)}</p>
                            </div>
                            <div class="flex gap-2">
                                ${state.isEditing ? `
                                    <button data-action="save" class="bg-green-500 text-white px-4 py-2 rounded-xl font-bold flex items-center gap-2 hover:bg-green-600 transition-all text-sm">
                                        <i data-lucide="save" width="16" height="16"></i> å„²å­˜
                                    </button>
                                    <button data-action="cancel-editing" class="bg-white/60 text-gray-600 px-4 py-2 rounded-xl font-bold hover:bg-white transition-all text-sm">å–æ¶ˆ</button>
                                ` : `
                                    ${permissions.canEdit() ? `
                                        <button data-action="start-editing" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-xl font-bold flex items-center gap-1 hover:bg-blue-100 transition-all text-sm">
                                            <i data-lucide="pencil" width="14" height="14"></i> ç·¨è¼¯
                                        </button>
                                    ` : ''}
                                    <button data-action="print" class="bg-white/60 text-gray-600 px-3 py-2 rounded-xl font-bold flex items-center gap-1 hover:bg-white transition-all text-sm">
                                        <i data-lucide="printer" width="14" height="14"></i>
                                    </button>
                                    <button data-action="close-booking-detail" class="w-10 h-10 bg-white/60 rounded-full flex items-center justify-center hover:bg-red-50 hover:text-dream-red transition-all">
                                        <i data-lucide="x" width="18" height="18"></i>
                                    </button>
                                `}
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto p-4 md:p-6 bg-dream-cream">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 space-y-4">
                                    <!-- é£¼ä¸»è³‡æ–™ -->
                                    <div class="glass-panel p-4 rounded-2xl">
                                        <h3 class="font-bold text-dream-navy flex items-center gap-2 mb-4">
                                            <i data-lucide="user" width="16" height="16"></i> é£¼ä¸»è³‡æ–™
                                        </h3>
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                            ${renderDetailItem('å§“å', booking.owner_name, 'owner_name')}
                                            ${renderDetailItem('é›»è©±', booking.phone, 'phone')}
                                            ${renderDetailItem('èº«åˆ†è­‰', r.owner_id, 'owner_id')}
                                            ${renderDetailItem('Email', r.email, 'email', true)}
                                            ${renderDetailItem('åœ°å€', r.address, 'address', true)}
                                            ${renderDetailItem('ç·Šæ€¥è¯çµ¡äºº', r.emergency_name, 'emergency_name')}
                                            ${renderDetailItem('ç·Šæ€¥é›»è©±', r.emergency_phone, 'emergency_phone')}
                                        </div>
                                    </div>

                                    <!-- å¯µç‰©è³‡æ–™ -->
                                    <div class="glass-panel p-4 rounded-2xl">
                                        <h3 class="font-bold text-dream-navy flex items-center gap-2 mb-4">
                                            <i data-lucide="heart" width="16" height="16"></i> å¯µç‰©è³‡æ–™
                                        </h3>
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                            ${renderDetailItem('åå­—', booking.pet_name, 'pet_name')}
                                            ${renderDetailItem('å“ç¨®', r.breed, 'breed')}
                                            ${renderDetailItem('æ€§åˆ¥', r.sex, 'sex')}
                                            ${renderDetailItem('çµç´®', r.fix, 'fix')}
                                            ${renderDetailItem('å¹´é½¡', `${r.age_value} ${r.age_type === 'year' ? 'æ­²' : 'å€‹æœˆ'}`, 'age_value')}
                                            ${renderDetailItem('é«”é‡', r.weight, 'weight')}
                                            ${renderDetailItem('æ™¶ç‰‡', r.chip_status, 'chip_status')}
                                            ${renderDetailItem('æ™¶ç‰‡è™Ÿç¢¼', r.chip_id, 'chip_id')}
                                        </div>
                                    </div>

                                    <!-- æœå‹™è³‡è¨Š -->
                                    <div class="glass-panel p-4 rounded-2xl">
                                        <h3 class="font-bold text-dream-navy flex items-center gap-2 mb-4">
                                            <i data-lucide="scissors" width="16" height="16"></i> æœå‹™è³‡è¨Š
                                        </h3>
                                        <div class="space-y-3">
                                            ${renderDetailItem('æœå‹™é …ç›®', booking.service_tags?.join(', ') || booking.service_type, 'service_type')}
                                            ${renderDetailItem('é‡‘é¡', booking.service_price, 'service_price')}
                                            ${renderDetailItem('å…¥ä½æ—¥æœŸ', booking.checkin_date, 'checkin_date')}
                                            ${renderDetailItem('é€€æˆ¿æ—¥æœŸ', booking.checkout_date, 'checkout_date')}
                                            ${renderDetailItem('é è¨ˆæ¥å›', booking.pickup_time, 'pickup_time')}
                                        </div>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <!-- è¨‚å–®ç‹€æ…‹ -->
                                    <div class="glass-panel p-4 rounded-2xl">
                                        <label class="text-xs font-bold text-gray-500 mb-3 block">è¨‚å–®ç‹€æ…‹</label>
                                        <div class="grid grid-cols-2 gap-2">
                                            ${['pending', 'confirmed', 'completed', 'cancelled'].map(status => `
                                                <button data-action="update-status" data-id="${booking.id}" data-status="${status}" class="py-2 px-3 rounded-lg font-bold text-sm flex items-center justify-center gap-1 border-2 transition-all ${booking.status === status ? 'bg-dream-navy text-white border-dream-navy' : 'bg-white/60 text-gray-500 border-gray-200 hover:border-dream-navy/30'}">
                                                    ${renderStatusBadge(status)}
                                                </button>
                                            `).join('')}
                                        </div>
                                    </div>

                                    <!-- ç°½åèˆ‡ç–«è‹— -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="glass-panel p-4 rounded-2xl">
                                            <h4 class="text-xs font-bold text-gray-500 mb-2">å®¢æˆ¶ç°½å</h4>
                                            ${booking.signature ? `<img src="${booking.signature}" class="w-full h-32 object-contain bg-white/60 rounded-lg" />` : '<div class="w-full h-32 bg-white/60 rounded-lg flex items-center justify-center text-gray-300 text-xs">ç„¡ç°½å</div>'}
                                        </div>
                                        <div class="glass-panel p-4 rounded-2xl">
                                            <h4 class="text-xs font-bold text-gray-500 mb-2">ç–«è‹—è­‰æ˜</h4>
                                            ${booking.vaccine_url ? `<a href="${booking.vaccine_url}" target="_blank"><img src="${booking.vaccine_url}" class="w-full h-32 object-cover rounded-lg hover:opacity-80 transition-opacity" /></a>` : '<div class="w-full h-32 bg-white/60 rounded-lg flex items-center justify-center text-gray-300 text-xs">ç„¡ç…§ç‰‡</div>'}
                                        </div>
                                    </div>

                                    <!-- Delete button -->
                                    ${!state.isEditing && permissions.canDelete() ? `
                                        <button data-action="delete" class="w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 text-dream-red hover:bg-red-50 transition-all border border-transparent hover:border-red-100">
                                            <i data-lucide="trash-2" width="16" height="16"></i> åˆªé™¤æ­¤è¨‚å–®
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    ${renderPrintContract(booking)}
                </div>
            `;
        };

        // æ¸²æŸ“è©³æƒ…é …ç›®
        const renderDetailItem = (label, value, fieldName, fullWidth = false) => {
            if (!value || value === 'ç„¡' || (Array.isArray(value) && value.length === 0)) return '';
            
            if (state.isEditing && fieldName) {
                const editVal = Array.isArray(state.editForm[fieldName]) ? state.editForm[fieldName].join(',') : (state.editForm[fieldName] || '');
                return `
                    <div class="${fullWidth ? 'col-span-2' : ''} bg-white p-3 rounded-xl border-2 border-dream-gold/50">
                        <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">${label}</label>
                        ${fieldName.includes('date') ? 
                            `<input type="date" class="w-full edit-input" value="${editVal}" onchange="state.editForm['${fieldName}'] = this.value" />` : 
                            `<input type="text" class="w-full edit-input" value="${editVal}" onchange="state.editForm['${fieldName}'] = this.value" />`
                        }
                    </div>
                `;
            }
            
            return `
                <div class="${fullWidth ? 'col-span-2' : ''} bg-dream-cream p-3 rounded-xl border border-white/50">
                    <label class="text-[10px] font-bold text-gray-500 uppercase block mb-1">${label}</label>
                    <div class="font-bold text-dream-navy text-sm break-words">
                        ${Array.isArray(value) ? value.join(', ') : value}
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“åˆ—å°å¥‘ç´„
        const renderPrintContract = (data) => {
            if (!data) return '';
            const r = data.raw_data || {};
            const isBoarding = !!data.checkin_date || (data.view === 'boarding');
            
            return `
                <div id="print-area" class="hidden">
                    <div class="max-w-[210mm] mx-auto space-y-4 p-4">
                        <div class="flex justify-between items-center border-b-2 border-dream-navy pb-2 mb-4">
                            <h1 class="text-2xl font-black text-dream-navy">å¤¢17ç²¾å“å¯µç‰©ç¾å®¹æ—…é¤¨ | æœå‹™å¥‘ç´„æ›¸</h1>
                            <div class="text-right text-xs">
                                <p>å–®è™Ÿï¼š#${data.id}</p>
                                <p>å¡«è¡¨æ—¥æœŸï¼š${formatDate(data.created_at)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1 border p-2 rounded border-dream-navy/20">
                                <h3 class="font-bold border-b pb-1 mb-1 text-dream-navy">ç”²æ–¹ (é£¼ä¸»è³‡æ–™)</h3>
                                <p><strong>å§“å:</strong> ${data.owner_name}</p>
                                <p><strong>é›»è©±:</strong> ${data.phone}</p>
                                <p><strong>èº«åˆ†è­‰:</strong> ${r.owner_id}</p>
                                <p><strong>åœ°å€:</strong> ${r.address}</p>
                                <p><strong>Email:</strong> ${r.email}</p>
                                <p><strong>ç·Šæ€¥è¯çµ¡:</strong> ${r.emergency_name} (${r.emergency_phone})</p>
                            </div>
                            <div class="space-y-1 border p-2 rounded border-dream-navy/20">
                                <h3 class="font-bold border-b pb-1 mb-1 text-dream-navy">ä¹™æ–¹ (å¯µç‰©è³‡æ–™)</h3>
                                <p><strong>åå­—:</strong> ${data.pet_name}</p>
                                <p><strong>å“ç¨®:</strong> ${r.breed}</p>
                                <p><strong>æ€§åˆ¥/çµç´®:</strong> ${r.sex} / ${r.fix}</p>
                                <p><strong>å¹´é½¡/é«”é‡:</strong> ${r.age_value} ${r.age_type === 'year' ? 'æ­²' : 'å€‹æœˆ'} / ${r.weight} kg</p>
                                <p><strong>æ™¶ç‰‡:</strong> ${r.chip_status} ${r.chip_id ? `(${r.chip_id})` : ''}</p>
                            </div>
                        </div>
                        <div class="border-2 border-dream-navy p-3 rounded mt-2">
                            <h3 class="font-bold text-sm mb-2 text-dream-navy">æœå‹™å…§å®¹ç¢ºèª</h3>
                            <p><strong>é …ç›®:</strong> ${data.service_tags?.join(', ') || data.service_type}</p>
                            <p><strong>é‡‘é¡:</strong> NT$ ${data.service_price}</p>
                            ${isBoarding ? `
                                <p><strong>å…¥ä½:</strong> ${data.checkin_date}</p>
                                <p><strong>é€€æˆ¿:</strong> ${data.checkout_date}</p>
                            ` : ''}
                        </div>
                        <div class="mt-4 pt-2 border-t-2 border-dream-navy">
                            <p class="text-xs mb-2">æœ¬äººå·²è©³é–±ä¸¦åŒæ„æœ¬é¤¨ä¹‹æœå‹™æ¢æ¬¾ï¼Œç¢ºèªä¸Šè¿°å¡«å¯«è³‡æ–™å±¬å¯¦ç„¡èª¤ã€‚</p>
                            <div class="flex justify-between items-end mt-4">
                                <div class="w-1/2">
                                    <p class="font-bold mb-1">é£¼ä¸»ç°½ç½²ï¼š</p>
                                    ${data.signature ? `<img src="${data.signature}" class="h-16 object-contain border-b border-dashed border-gray-400 w-full" />` : '<div class="h-16 border-b border-dashed border-gray-400 w-full"></div>'}
                                </div>
                                <div class="text-right"><p class="text-xs">ç°½ç½²æ™‚é–“ï¼š${formatDateTime(data.created_at)}</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“ä¿®æ”¹å¯†ç¢¼æ¨¡æ…‹æ¡†
        const renderChangePasswordModal = () => {
            const currentUserEmail = state.session?.user?.email;
            
            return `
                <div class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                    <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4">
                        <div class="text-center">
                            <h3 class="text-lg font-black text-dream-navy mb-1">è®Šæ›´å¯†ç¢¼</h3>
                            <p class="text-xs text-gray-500">ç›®å‰ä¿®æ”¹å°è±¡ï¼š${state.targetEmail === ADMIN_EMAIL ? 'ç®¡ç†å“¡' : 'å“¡å·¥'}</p>
                        </div>

                        ${currentUserEmail === ADMIN_EMAIL ? `
                            <div class="flex bg-white/60 p-1 rounded-xl">
                                <button data-action="set-target-email" data-email="${ADMIN_EMAIL}" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all ${state.targetEmail === ADMIN_EMAIL ? 'bg-white shadow text-dream-navy' : 'text-gray-500'}">ä¿®æ”¹è‡ªå·±</button>
                                <button data-action="set-target-email" data-email="${STAFF_EMAIL}" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all ${state.targetEmail === STAFF_EMAIL ? 'bg-white shadow text-blue-500' : 'text-gray-500'}">ä¿®æ”¹å“¡å·¥</button>
                            </div>
                        ` : ''}

                        <div class="space-y-4">
                            <input type="password" id="oldPasswordInput" value="${state.oldPassword}" class="w-full edit-input py-3" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" />
                            <hr class="border-dashed border-gray-300" />
                            <input type="password" id="newPasswordInput" value="${state.newPassword}" class="w-full edit-input py-3" placeholder="æ–°å¯†ç¢¼ (è‡³å°‘6ä½)" />
                            <input type="password" id="confirmPasswordInput" value="${state.confirmPassword}" class="w-full edit-input py-3" placeholder="ç¢ºèªæ–°å¯†ç¢¼" />
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button data-action="close-password-modal" class="flex-1 py-3 rounded-xl bg-white/60 text-gray-600 font-bold hover:bg-white transition-all">å–æ¶ˆ</button>
                            <button data-action="update-password" class="flex-1 py-3 rounded-xl bg-dream-navy text-white font-bold hover:bg-[#4A3D35] transition-all">ç¢ºèªä¿®æ”¹</button>
                        </div>
                    </div>
                </div>
            `;
        };

        // æ¸²æŸ“ç¢ºèªæ¨¡æ…‹æ¡†
        const renderConfirmModal = () => {
            return `
                <div class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm fade-in">
                    <div class="glass-panel w-full max-w-sm rounded-3xl p-6 space-y-4">
                        <div class="text-center">
                            <div class="w-12 h-12 bg-dream-gold/20 text-dream-navy rounded-full flex items-center justify-center mx-auto mb-3">
                                <i data-lucide="lock" width="24" height="24"></i>
                            </div>
                            <h3 class="text-lg font-black text-dream-navy">${state.confirmAction === 'delete' ? 'åˆªé™¤ç¢ºèª' : 'å„²å­˜è®Šæ›´ç¢ºèª'}</h3>
                            <p class="text-sm text-gray-500 mt-1">æ­¤ç‚ºæ•æ„Ÿæ“ä½œï¼Œè«‹è¼¸å…¥å¯†ç¢¼ä»¥ç¢ºèªã€‚</p>
                        </div>
                        <input type="password" id="confirmPasswordInput" placeholder="è«‹è¼¸å…¥æ‚¨çš„å¯†ç¢¼" class="w-full text-center py-3 border-2 border-gray-200 rounded-xl focus:border-dream-navy outline-none font-bold bg-white" autofocus />
                        <div class="flex gap-3 pt-2">
                            <button data-action="close-confirm-modal" class="flex-1 py-3 rounded-xl bg-white/60 text-gray-600 font-bold hover:bg-white transition-all">å–æ¶ˆ</button>
                            <button data-action="execute-action" disabled="${state.actionLoading}" class="flex-1 py-3 rounded-xl bg-dream-navy text-white font-bold hover:bg-[#4A3D35] disabled:opacity-50 transition-all flex items-center justify-center gap-2">
                                ${state.actionLoading ? '<i data-lucide="loader-2" class="animate-spin"></i>' : 'ç¢ºèªåŸ·è¡Œ'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        // è¨­ç½®å…¨å±€äº‹ä»¶å§”æ´¾
        const setupEventDelegation = () => {
            document.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.getAttribute('data-action');
                
                switch (action) {
                    case 'set-login-email':
                        setLoginEmail(target.getAttribute('data-email'));
                        break;
                        
                    case 'login':
                        e.preventDefault();
                        handleLogin(e);
                        break;
                        
                    case 'reset-login':
                        resetLogin();
                        break;
                        
                    case 'fetch-bookings':
                        fetchBookings();
                        break;
                        
                    case 'logout':
                        handleLogout();
                        break;
                        
                    case 'show-password-modal':
                        showPasswordModal();
                        break;
                        
                    case 'set-active-tab':
                        setActiveTab(target.getAttribute('data-tab'));
                        break;
                        
                    case 'set-view-mode':
                        setViewMode(target.getAttribute('data-mode'));
                        break;
                        
                    case 'toggle-select-booking':
                        toggleSelectBooking(target.getAttribute('data-id'));
                        break;
                        
                    case 'select-booking':
                        selectBooking(target.getAttribute('data-id'));
                        break;
                        
                    case 'select-all-bookings':
                        selectAllBookings();
                        break;
                        
                    case 'export-excel':
                        exportToExcel(getFilteredBookings());
                        break;
                        
                    case 'prev-month':
                        prevMonth();
                        break;
                        
                    case 'next-month':
                        nextMonth();
                        break;
                        
                    case 'go-today':
                        goToday();
                        break;
                        
                    case 'close-booking-detail':
                        closeBookingDetail();
                        break;
                        
                    case 'start-editing':
                        startEditing();
                        break;
                        
                    case 'cancel-editing':
                        cancelEditing();
                        break;
                        
                    case 'save':
                        triggerAction('save');
                        break;
                        
                    case 'delete':
                        triggerAction('delete');
                        break;
                        
                    case 'update-status':
                        updateStatus(target.getAttribute('data-id'), target.getAttribute('data-status'));
                        break;
                        
                    case 'set-target-email':
                        setTargetEmail(target.getAttribute('data-email'));
                        break;
                        
                    case 'close-password-modal':
                        closePasswordModal();
                        break;
                        
                    case 'update-password':
                        updatePassword();
                        break;
                        
                    case 'close-confirm-modal':
                        closeConfirmModal();
                        break;
                        
                    case 'execute-action':
                        const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                        if (confirmPasswordInput) {
                            executeAction(confirmPasswordInput.value);
                        }
                        break;
                }
            });
        };

        // äº‹ä»¶è™•ç†å‡½æ•¸
        const setActiveTab = (tab) => {
            state.activeTab = tab;
            render();
        };

        const setViewMode = (mode) => {
            state.viewMode = mode;
            render();
        };

        const selectBooking = (id) => {
            state.selectedBooking = state.bookings.find(b => b.id === id);
            state.isEditing = false;
            render();
        };

        const closeBookingDetail = () => {
            state.selectedBooking = null;
            state.isEditing = false;
            render();
        };

        const cancelEditing = () => {
            state.isEditing = false;
            render();
        };

        const showPasswordModal = () => {
            state.targetEmail = state.session?.user?.email;
            state.oldPassword = '';
            state.newPassword = '';
            state.confirmPassword = '';
            state.showPasswordModal = true;
            render();
            
            // è¨­ç½®ç„¦é»åˆ°ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
            setTimeout(() => {
                const oldPasswordInput = document.getElementById('oldPasswordInput');
                if (oldPasswordInput) oldPasswordInput.focus();
            }, 100);
        };

        const closePasswordModal = () => {
            state.showPasswordModal = false;
            render();
        };

        const setTargetEmail = (email) => {
            state.targetEmail = email;
            render();
            
            // è¨­ç½®ç„¦é»åˆ°ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
            setTimeout(() => {
                const oldPasswordInput = document.getElementById('oldPasswordInput');
                if (oldPasswordInput) oldPasswordInput.focus();
            }, 100);
        };

        const updatePassword = async () => {
            const oldPasswordInput = document.getElementById('oldPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            
            const oldPassword = oldPasswordInput ? oldPasswordInput.value : state.oldPassword;
            const newPassword = newPasswordInput ? newPasswordInput.value : state.newPassword;
            const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : state.confirmPassword;
            
            if (!oldPassword) { showToast('è«‹è¼¸å…¥è©²å¸³è™Ÿçš„èˆŠå¯†ç¢¼', 'error'); return; }
            if (newPassword.length < 6) { showToast('æ–°å¯†ç¢¼é•·åº¦è‡³å°‘éœ€ 6 å€‹å­—å…ƒ', 'error'); return; }
            if (newPassword !== confirmPassword) { showToast('å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ç›¸ç¬¦', 'error'); return; }
            
            try {
                const { error: signInError } = await state.supabase.auth.signInWithPassword({ 
                    email: state.targetEmail, 
                    password: oldPassword 
                });
                if (signInError) throw new Error("èˆŠå¯†ç¢¼è¼¸å…¥éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰èº«åˆ†");

                const { error: updateError } = await state.supabase.auth.updateUser({ password: newPassword });
                if (updateError) throw updateError;
                
                showToast(`å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼å³å°‡é‡æ–°æ•´ç†...`, 'success');
                
                setTimeout(async () => {
                    await state.supabase.auth.signOut();
                    window.location.reload();
                }, 1500);

            } catch (error) {
                showToast(error.message || 'ä¿®æ”¹å¤±æ•—', 'error');
            }
        };

        const closeConfirmModal = () => {
            state.showConfirm = false;
            render();
        };

        // æ—¥æ›†ç›¸é—œå‡½æ•¸
        let calendarDate = new Date();
        
        const prevMonth = () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            render();
        };
        
        const nextMonth = () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            render();
        };
        
        const goToday = () => {
            calendarDate = new Date();
            render();
        };

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹åº
        document.addEventListener('DOMContentLoaded', () => {
            initSupabase();
            setupEventDelegation();
        });
    </script>
</body>
</html>
          
